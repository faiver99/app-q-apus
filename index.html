<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Análisis de Precios Unitarios (APU) - Versión Local</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Libraries for Exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .table-container { max-height: 300px; overflow-y: auto; }
        .input-number::-webkit-outer-spin-button, .input-number::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-number { -moz-appearance: textfield; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 40; -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }
        .toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; opacity: 0; transition: visibility 0s, opacity 0.5s linear; }
        .toast.show { visibility: visible; opacity: 1; }
        @media print { body, .modal { all: unset; } #apuViewerContainer { display: block; box-shadow: none; border: none; } .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app-container" class="p-4 md:p-8">
        <div class="max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
            <!-- HEADER -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 pb-4 border-b">
                <div><h1 class="text-3xl font-bold text-gray-800">Creador de APU</h1><p class="text-gray-500 mt-1">Versión de Almacenamiento Local</p></div>
                <div class="flex flex-wrap items-center gap-2 mt-4 md:mt-0">
                     <button id="newApuBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-600 transition-colors flex items-center"><i class="fas fa-plus mr-2"></i>Nuevo APU</button>
                    <button id="viewSavedApusBtn" class="bg-gray-700 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-800 transition-colors flex items-center"><i class="fas fa-save mr-2"></i>Ver Guardados</button>
                    <button id="manageInsumosBtn" class="bg-teal-500 text-white px-4 py-2 rounded-lg shadow hover:bg-teal-600 transition-colors flex items-center"><i class="fas fa-boxes-stacked mr-2"></i>Base de Insumos</button>
                    <button id="managePersonnelBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-600 transition-colors flex items-center"><i class="fas fa-user-friends mr-2"></i>Base de Personal</button>
                </div>
            </div>

            <!-- ACTIVITY DETAILS -->
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
                <div class="md:col-span-4"><label for="activityName" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Actividad</label><input type="text" id="activityName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: Muro en ladrillo a la vista"></div>
                <div class="md:col-span-2"><label for="activityUnit" class="block text-sm font-medium text-gray-700 mb-1">Unidad</label><input type="text" id="activityUnit" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: M2"></div>
            </div>
            <!-- APU EDITOR SECTIONS -->
            <div id="apu-editor-sections" class="space-y-12">
                <section><h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-indigo-500 pb-2"><i class="fas fa-box-open mr-3 text-indigo-500"></i>MATERIALES</h2><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"><input list="materials-datalist" id="material-selector" placeholder="Buscar material..." class="w-full p-2 border rounded-lg md:col-span-2"><datalist id="materials-datalist"></datalist><input type="number" id="material-quantity" placeholder="Cantidad" class="input-number w-full p-2 border rounded-lg"><button id="add-material-btn" class="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">Añadir Material</button></div><div class="table-container border rounded-lg"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr><th class="px-6 py-3">Descripción</th><th class="px-6 py-3">Unidad</th><th class="px-6 py-3">Cantidad</th><th class="px-6 py-3">Vr. Unitario</th><th class="px-6 py-3">Total</th><th class="px-2 py-3"></th></tr></thead><tbody id="materials-table"></tbody></table></div><div class="flex justify-end mt-2 pr-4"><div class="flex items-center space-x-4"><h3 class="font-semibold text-gray-600">SUBTOTAL MATERIALES:</h3><p id="subtotal-materials" class="text-lg font-bold text-gray-800">$ 0</p></div></div></section>
                <section><h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-orange-500 pb-2"><i class="fas fa-truck mr-3 text-orange-500"></i>TRANSPORTE</h2><div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4"><input type="text" id="transport-description" placeholder="Descripción" class="w-full p-2 border rounded-lg md:col-span-2"><input type="text" id="transport-unit" placeholder="Unidad (ej. Viaje)" class="w-full p-2 border rounded-lg"><input type="number" id="transport-quantity" placeholder="Cantidad" class="input-number w-full p-2 border rounded-lg"><input type="number" id="transport-price" placeholder="Vr. Unitario" class="input-number w-full p-2 border rounded-lg"><button id="add-transport-btn" class="w-full bg-orange-500 text-white p-2 rounded-lg hover:bg-orange-600">Añadir</button></div><div class="table-container border rounded-lg"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr><th class="px-6 py-3">Descripción</th><th class="px-6 py-3">Unidad</th><th class="px-6 py-3">Cantidad</th><th class="px-6 py-3">Vr. Unitario</th><th class="px-6 py-3">Total</th><th class="px-2 py-3"></th></tr></thead><tbody id="transport-table"></tbody></table></div><div class="flex justify-end mt-2 pr-4"><div class="flex items-center space-x-4"><h3 class="font-semibold text-gray-600">SUBTOTAL TRANSPORTE:</h3><p id="subtotal-transport" class="text-lg font-bold text-gray-800">$ 0</p></div></div></section>
                <section>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-yellow-500 pb-2"><i class="fas fa-tools mr-3 text-yellow-500"></i>EQUIPOS Y HERRAMIENTAS</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"><input list="equipments-datalist" id="equipment-selector" placeholder="Buscar equipo..." class="w-full p-2 border rounded-lg md:col-span-2"><datalist id="equipments-datalist"></datalist><input type="number" id="equipment-performance" placeholder="Rendimiento" class="input-number w-full p-2 border rounded-lg"><button id="add-equipment-btn" class="w-full bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600">Añadir Equipo</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-center bg-yellow-50 p-2 rounded-lg">
                        <label for="herramienta-menor-pct" class="md:col-span-2 font-medium text-gray-700">Herramienta Menor (% de Mano de Obra):</label>
                        <div class="relative">
                            <input type="number" id="herramienta-menor-pct" value="0" placeholder="% Herramienta Menor" class="input-number w-full p-2 border rounded-lg pr-8">
                            <button type="button" id="clear-herramienta-menor-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-red-600" title="Eliminar Herramienta Menor">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        </div>
                        <div></div>
                    </div>
                    <div class="table-container border rounded-lg"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr><th class="px-6 py-3">Descripción</th><th class="px-6 py-3">Unidad</th><th class="px-6 py-3">Rendimiento / %</th><th class="px-6 py-3">Vr. Unitario / Base</th><th class="px-6 py-3">Total</th><th class="px-2 py-3"></th></tr></thead><tbody id="equipment-table"></tbody><tbody id="herramienta-menor-container"></tbody></table></div>
                    <div class="flex justify-end mt-2 pr-4"><div class="flex items-center space-x-4"><h3 class="font-semibold text-gray-600">SUBTOTAL EQUIPOS:</h3><p id="subtotal-equipment" class="text-lg font-bold text-gray-800">$ 0</p></div></div>
                </section>
                <section>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-green-500 pb-2"><i class="fas fa-users-cog mr-3 text-green-500"></i>MANO DE OBRA</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                        <input list="labor-datalist" id="labor-selector" placeholder="Buscar personal..." class="w-full p-2 border rounded-lg md:col-span-2">
                        <datalist id="labor-datalist"></datalist>
                        <input type="number" id="labor-quantity" placeholder="Cantidad" class="input-number w-full p-2 border rounded-lg" value="1">
                        <input type="number" id="labor-performance" placeholder="Rendimiento" class="input-number w-full p-2 border rounded-lg">
                        <button id="add-labor-btn" class="w-full bg-green-500 text-white p-2 rounded-lg hover:bg-green-600">Añadir</button>
                    </div>
                    <div class="table-container border rounded-lg"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr><th class="px-6 py-3">Descripción</th><th class="px-6 py-3">Unidad</th><th class="px-6 py-3">Cantidad</th><th class="px-6 py-3">Rendimiento</th><th class="px-6 py-3">Vr. Unitario</th><th class="px-6 py-3">Total</th><th class="px-2 py-3"></th></tr></thead><tbody id="labor-table"></tbody></table></div>
                    <div class="flex justify-end mt-2 pr-4"><div class="flex items-center space-x-4"><h3 class="font-semibold text-gray-600">SUBTOTAL MANO DE OBRA:</h3><p id="subtotal-labor" class="text-lg font-bold text-gray-800">$ 0</p></div></div>
                </section>
            </div>
            <!-- SUMMARY AND TOTALS -->
            <div id="apu-summary-sections" class="mt-12 pt-6 border-t-2 border-gray-300 space-y-4 max-w-2xl ml-auto">
                <div class="flex justify-between items-center bg-indigo-100 p-3 rounded-lg"><h3 class="font-bold text-indigo-800 text-lg">COSTO DIRECTO (A)</h3><p id="direct-cost" class="text-xl font-extrabold text-indigo-900">$ 0</p></div>
                <div class="p-4 border rounded-lg space-y-3 bg-gray-50"><div class="flex justify-between items-center"><div class="flex items-center space-x-2 flex-1"><label for="admin-percentage" class="w-32 font-semibold text-gray-700">Administración (%):</label><input type="number" id="admin-percentage" value="15" class="input-number p-2 border rounded-lg w-24 text-center font-bold"></div><p id="admin-value" class="text-lg font-bold text-gray-800 text-right w-36">$ 0</p></div><div class="flex justify-between items-center"><div class="flex items-center space-x-2 flex-1"><label for="imprevistos-percentage" class="w-32 font-semibold text-gray-700">Imprevistos (%):</label><input type="number" id="imprevistos-percentage" value="5" class="input-number p-2 border rounded-lg w-24 text-center font-bold"></div><p id="imprevistos-value" class="text-lg font-bold text-gray-800 text-right w-36">$ 0</p></div><div class="flex justify-between items-center"><div class="flex items-center space-x-2 flex-1"><label for="utilidad-percentage" class="w-32 font-semibold text-gray-700">Utilidad (%):</label><input type="number" id="utilidad-percentage" value="5" class="input-number p-2 border rounded-lg w-24 text-center font-bold"></div><p id="utilidad-value" class="text-lg font-bold text-gray-800 text-right w-36">$ 0</p></div></div>
                <div class="flex justify-between items-center bg-gray-200 p-3 rounded-lg"><h3 class="font-bold text-gray-800 text-lg">COSTOS INDIRECTOS (B)</h3><p id="indirect-cost-display" class="text-xl font-extrabold text-gray-900">$ 0</p></div>
                <div class="flex justify-between items-center bg-green-600 text-white p-4 rounded-lg"><h3 class="text-xl font-bold">PRECIO TOTAL (A+B) / <span id="total-unit-label">UNIDAD</span></h3><p id="total-cost" class="text-3xl font-extrabold">$ 0</p></div>
            </div>
            <!-- SAVE BUTTON -->
            <div class="mt-8 flex justify-end"><button id="saveApuBtn" class="bg-green-600 text-white px-8 py-3 rounded-lg shadow-lg hover:bg-green-700 transition-colors text-lg font-bold flex items-center"><i class="fas fa-database mr-3"></i>Guardar APU</button></div>
        </div>
    </div>
    
    <!-- MODALS & TOAST -->
    <div id="savedApusModalBackdrop" class="modal-backdrop"></div><div id="savedApusModal" class="modal bg-white rounded-xl shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-w-4xl"><div class="p-6 border-b flex flex-col sm:flex-row justify-between items-center gap-4"><h2 class="text-2xl font-bold text-gray-800 shrink-0">APUs Guardados</h2><div class="relative w-full sm:w-1/2"><input type="text" id="apuSearchInput" placeholder="Buscar APU por nombre..." class="w-full p-2 pl-10 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div><button id="closeApusModalBtn" class="text-gray-500 hover:text-red-600 text-2xl absolute top-4 right-4 sm:static">&times;</button></div><div id="savedApusList" class="p-6 max-h-[60vh] overflow-y-auto"><p id="loadingApusText">Cargando APUs...</p></div></div>
    <div id="insumosModalBackdrop" class="modal-backdrop"></div><div id="insumosModal" class="modal bg-white rounded-xl shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-w-5xl"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">Base de Insumos</h2><button id="closeInsumosModalBtn" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button></div><div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1"><h3 id="insumo-form-title" class="font-semibold text-lg mb-3">Añadir Nuevo Insumo</h3><form id="add-insumo-form" class="space-y-3"><input type="hidden" id="editing-insumo-id"><select id="insumo-type" class="w-full p-2 border rounded-lg bg-gray-50"><option value="material">Material</option><option value="equipment">Equipo</option></select><input type="text" id="insumo-description" placeholder="Descripción" class="w-full p-2 border rounded-lg" required><input type="text" id="insumo-unit" placeholder="Unidad" class="w-full p-2 border rounded-lg" required><input type="number" id="insumo-price" placeholder="Precio Unitario" class="input-number w-full p-2 border rounded-lg" required><div id="insumo-form-buttons" class="space-y-2"><button type="submit" id="insumo-submit-btn" class="w-full bg-teal-500 text-white p-2 rounded-lg hover:bg-teal-600">Añadir a la Base</button><button type="button" id="insumo-cancel-btn" class="w-full bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600 hidden">Cancelar Edición</button></div></form></div><div class="md:col-span-2"><h3 class="font-semibold text-lg mb-3">Lista de Insumos</h3><div id="insumos-list-container" class="max-h-[50vh] overflow-y-auto border rounded-lg"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr><th scope="col" class="px-4 py-2">Descripción</th><th scope="col" class="px-4 py-2">Unidad</th><th scope="col" class="px-4 py-2">Precio</th><th scope="col" class="px-4 py-2">Tipo</th><th scope="col" class="px-1 py-2">Acciones</th></tr></thead><tbody id="insumos-table-body"><tr><td colspan="5" class="text-center p-4" id="loadingInsumosText">Cargando...</td></tr></tbody></table></div></div></div></div>
    <div id="personnelModalBackdrop" class="modal-backdrop"></div><div id="personnelModal" class="modal bg-white rounded-xl shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-w-5xl"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">Base de Personal</h2><button id="closePersonnelModalBtn" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button></div><div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1"><h3 id="personnel-form-title" class="font-semibold text-lg mb-3">Añadir Nuevo Personal</h3><form id="add-personnel-form" class="space-y-3"><input type="hidden" id="editing-personnel-id"><input type="text" id="personnel-description" placeholder="Cargo (Ej: Oficial, Ayudante)" class="w-full p-2 border rounded-lg" required><input type="number" id="personnel-wage" placeholder="Jornal Básico" class="input-number w-full p-2 border rounded-lg" required><input type="number" id="personnel-benefits" placeholder="Prestaciones Sociales (%)" class="input-number w-full p-2 border rounded-lg" required><div id="personnel-form-buttons" class="space-y-2"><button type="submit" id="personnel-submit-btn" class="w-full bg-purple-500 text-white p-2 rounded-lg hover:bg-purple-600">Añadir a la Base</button><button type="button" id="personnel-cancel-btn" class="w-full bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600 hidden">Cancelar Edición</button></div></form></div><div class="md:col-span-2"><h3 class="font-semibold text-lg mb-3">Lista de Personal</h3><div id="personnel-list-container" class="max-h-[50vh] overflow-y-auto border rounded-lg"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr><th scope="col" class="px-4 py-2">Cargo</th><th scope="col" class="px-4 py-2">Jornal Básico</th><th scope="col" class="px-4 py-2">Prestaciones (%)</th><th scope="col" class="px-4 py-2">Jornal Total</th><th scope="col" class="px-1 py-2">Acciones</th></tr></thead><tbody id="personnel-table-body"><tr><td colspan="5" class="text-center p-4" id="loadingPersonnelText">Cargando...</td></tr></tbody></table></div></div></div></div>
    <div id="viewerModalBackdrop" class="modal-backdrop"></div><div id="viewerModal" class="modal bg-gray-100 rounded-xl shadow-2xl w-11/12 max-w-4xl"><div class="p-4 bg-white rounded-t-xl border-b flex justify-between items-center no-print"><h2 class="text-2xl font-bold text-gray-800">Vista de Reporte APU</h2><div class="flex items-center gap-2"><button id="downloadPdfBtn" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 flex items-center gap-2"><i class="fas fa-file-pdf"></i>PDF</button><button id="downloadExcelBtn" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 flex items-center gap-2"><i class="fas fa-file-excel"></i>Excel</button><button id="closeViewerModalBtn" class="text-gray-500 hover:text-red-600 text-2xl ml-4">&times;</button></div></div><div id="apuViewerContainer" class="p-8 max-h-[85vh] overflow-y-auto bg-white"></div></div>
    <div id="confirmModalBackdrop" class="modal-backdrop"></div><div id="confirmModal" class="modal bg-white rounded-xl shadow-2xl w-11/12 max-w-md"><div class="p-6"><h3 class="text-lg font-bold text-gray-900" id="confirmModalTitle">Confirmar Acción</h3><p class="mt-2 text-sm text-gray-600" id="confirmModalText">¿Estás seguro?</p></div><div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3 rounded-b-xl"><button id="confirmModalCancelBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button id="confirmModalConfirmBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Confirmar</button></div></div>
    <div id="toast" class="toast"></div>

    <script type="module" src="script.js" defer></script>
</body>
</html>
